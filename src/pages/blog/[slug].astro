---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/layout/Header.astro";
import Footer from "../../components/layout/Footer.astro";
import { Image } from "astro:assets";
import { posts, type BlogPost } from "../../data/posts";

export function getStaticPaths() {
	return posts
		.filter((post): post is BlogPost => post != null && post.slug != null)
		.map((post) => ({
			params: { slug: post.slug },
			props: { post },
		}));
}

interface Props {
	post: BlogPost;
}

const { post } = Astro.props;

const relatedPosts = posts
	.filter((p) => p && p.slug !== post.slug)
	.slice(0, 3);

const contentParagraphs = post.content.split("\n\n").filter(Boolean);
---

<Layout>
	<Header />
	<main>
		<article>
			<div class='relative'>
				<div class='w-full h-[300px] md:h-[420px] overflow-hidden'>
					<Image
						src={post.image}
						alt={post.title}
						class='w-full h-full object-cover'
					/>
					<div class='absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent'></div>
				</div>
				<div class='absolute bottom-0 left-0 right-0 px-6 md:px-10 lg:px-16 pb-8 md:pb-12'>
					<div class='max-w-4xl mx-auto'>
						<span class='inline-block px-4 py-1.5 rounded-full text-sm font-body font-medium bg-accent-orange text-white mb-4'>
							{post.category}
						</span>
						<h1 class='font-heading text-2xl md:text-4xl lg:text-5xl font-medium text-white leading-tight mb-3'>
							{post.title}
						</h1>
						<div class='flex items-center gap-4 text-white/80 text-sm font-body'>
							{post.author && <span>{post.author}</span>}
							<span class='w-1 h-1 rounded-full bg-white/60'></span>
							<time>{post.date}</time>
						</div>
					</div>
				</div>
			</div>

			<div class='px-6 md:px-10 lg:px-16 py-10 md:py-16'>
				<div class='max-w-4xl mx-auto'>
					<div class='blog-content font-body text-kfood-body leading-relaxed'>
						{
							contentParagraphs.map((para) => {
								if (para.startsWith("## ")) {
									return <h2 class='font-heading text-xl md:text-2xl font-medium text-kfood-primary mt-10 mb-4'>{para.replace("## ", "")}</h2>;
								}
								if (para.startsWith("1. ") || para.startsWith("- ")) {
									const items = para.split("\n").filter(Boolean);
									return (
										<ul class='list-disc pl-6 space-y-2 mb-6 text-base md:text-lg'>
											{items.map((item) =>
												item ? (
													<li set:html={item.replace(/^\d+\.\s\*\*(.+?)\*\*/, "<strong>$1</strong>").replace(/^-\s/, "")} />
												) : null,
											)}
										</ul>
									);
								}
								return <p class='text-base md:text-lg mb-6' set:html={para} />;
							})
						}
					</div>

					<div class='mt-12 pt-8 border-t border-gray-200'>
						<a
							href='/blog'
							class='inline-flex items-center gap-2 font-body text-kfood-primary hover:text-accent-orange transition-colors font-medium'>
							<svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'>
								<path stroke-linecap='round' stroke-linejoin='round' d='M15 19l-7-7 7-7' />
							</svg>
							Back to all posts
						</a>
					</div>
				</div>
			</div>
		</article>

		{relatedPosts.length > 0 && (
			<section class='bg-gray-50 py-12 md:py-16'>
				<div class='px-6 md:px-10 lg:px-16 max-w-6xl mx-auto'>
					<h2 class='text-heading-section text-center mb-10'>More Posts</h2>
					<div class='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8'>
						{relatedPosts.map((rp) =>
							rp ? (
								<a
									href={`/blog/${rp.slug}`}
									class='group block rounded-card overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300'>
									<div class='relative overflow-hidden'>
										<Image
											src={rp.image}
											alt={rp.title}
											class='w-full h-[200px] object-cover group-hover:scale-105 transition-transform duration-500'
										/>
										<span class='absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-body font-medium bg-accent-orange text-white'>
											{rp.category}
										</span>
									</div>
									<div class='p-5 bg-white'>
										<p class='text-xs font-body text-muted mb-2'>{rp.date}</p>
										<h3 class='font-heading text-lg font-medium text-kfood-primary group-hover:text-accent-orange transition-colors'>
											{rp.title}
										</h3>
									</div>
								</a>
							) : null,
						)}
					</div>
				</div>
			</section>
		)}
	</main>
	<Footer />
</Layout>
