---
import Logo from "../../assets/logo.png";
import type { ImageMetadata } from "astro";
import { Menu, X, ChevronDown } from "@lucide/astro";
import Button from "../ui/Button.astro";

const logo: ImageMetadata = Logo;
interface Announcement {
	label: string;
	href: string;
}

const announcments: Announcement[] = [
	{ label: "Bilona Neeli Ravi Desi Ghee - Now Available Online", href: "#" },
	{ label: "Discover Our Selection of 6 Premium Flours", href: "#" },
	{ label: "KFood Now Live in 8 Cities Across Pakistan", href: "#" },
	{ label: "Pure, Traditional, and Delivered to Your Doorstep", href: "#" },
	{ label: "Quality You Can Trust, Products Youâ€™ll Love", href: "#" },
];

const productCategories = [
	// { label: "Butter", href: "#products-ghee", type: "ghee" },
	{ label: "Flour", href: "#products-flour", type: "flour" },
	// { label: "Milk", href: "#products-flour", type: "flour" },
	{ label: "Yogurt", href: "#products-yogurt", type: "yogurt" },
	{ label: "Ghee", href: "#products-ghee", type: "ghee" },
];
---

<header class='sticky top-0 z-50'>
	<div
		class='announcement-bar h-10 md:h-12 w-full bg-kfood-primary flex items-center justify-center'
		data-announcements={JSON.stringify(announcments)}>
		<div class='container mx-auto px-4 md:px-10 flex justify-center'>
			<a
				id='announcement-bar-link'
				href={announcments[0]?.href ?? "#"}
				class='block text-white text-sm md:text-base font-body text-center hover:opacity-90 transition-opacity'>
				{announcments[0]?.label ?? ""}
			</a>
		</div>
	</div>
	<nav
		class='flex min-h-[80px] md:min-h-[110px] items-center justify-between bg-kfood-background px-4 py-4 md:px-10 font-body'>
		<a href='/' class='flex shrink-0'>
			<img src={logo.src} alt='K Food Logo' class='h-[50px] md:h-[79px] w-auto object-contain' />
		</a>

		<div>
			<ul class='hidden items-center gap-6 lg:flex xl:gap-8 text-[15px] leading-[15px] text-kfood-primary'>
				<li><a href='/' class='hover:opacity-80 transition-opacity cursor-pointer'>Home</a></li>
				<li><a href='/#about-kfood' class='hover:opacity-80 transition-opacity cursor-pointer'>About KFood</a></li>
				<li class='relative' id='products-nav-item'>
					<button
						type='button'
						class='flex items-center gap-0.5 hover:opacity-80 transition-opacity bg-transparent border-none cursor-pointer text-inherit text-[15px] leading-[15px] font-inherit p-0'
						aria-expanded='false'
						aria-haspopup='true'
						aria-controls='products-dropdown'
						id='products-trigger'>
						Products
						<ChevronDown class='h-5 w-5 shrink-0 text-kfood-primary transition-transform' id='products-chevron' />
					</button>
					<ul
						id='products-dropdown'
						class='absolute left-0 top-full pt-2 hidden min-w-[160px] list-none'
						aria-hidden='true'>
						<li>
							<ul class='bg-kfood-background border border-gray-200 rounded-lg shadow-lg overflow-hidden list-none'>
								<li>
									<a href='/#products' class='block px-4 py-2.5 text-kfood-primary hover:bg-gray-100 cursor-pointer'
										>View all</a
									>
								</li>
								{
									productCategories.map((cat) =>
										cat ? (
											<li>
												<a
													href={cat.href}
													class='block px-4 py-2.5 text-kfood-primary hover:bg-gray-100 cursor-pointer'
													data-product-type={cat.type}>
													{cat.label}
												</a>
											</li>
										) : null,
									)
								}
							</ul>
						</li>
					</ul>
				</li>
				<!-- <li class='relative' id='brands-nav-item'>
					<button
						type='button'
						class='flex items-center gap-0.5 hover:opacity-80 transition-opacity bg-transparent border-none cursor-pointer text-inherit text-[15px] leading-[15px] font-inherit p-0'
						aria-expanded='false'
						aria-haspopup='true'
						aria-controls='brands-dropdown'
						id='brands-trigger'>
						Our Brands
						<ChevronDown class='h-5 w-5 shrink-0 text-kfood-primary transition-transform' id='brands-chevron' />
					</button>
					<ul
						id='brands-dropdown'
						class='absolute left-0 top-full pt-2 hidden min-w-[160px] list-none'
						aria-hidden='true'>
						<li>
							<ul class='bg-kfood-background border border-gray-200 rounded-lg shadow-lg overflow-hidden list-none'>
								{
									brandLinks.map((item) =>
										item ? (
											<li>
												<a
													href={item.href}
													class='block px-4 py-2.5 text-kfood-primary hover:bg-gray-100 cursor-pointer'>
													{item.label}
												</a>
											</li>
										) : null,
									)
								}
							</ul>
						</li>
					</ul>
				</li> -->
				<li>
					<a
						href='https://waseela.global/career'
						target='_blank'
						rel='noopener noreferrer'
						class='hover:opacity-80 transition-opacity cursor-pointer'>
						Careers
					</a>
				</li>
				<li><a href='/#store-locator' class='hover:opacity-80 transition-opacity cursor-pointer'>Find a Store</a></li>
				<li><a href='/#partner-form' class='hover:opacity-80 transition-opacity cursor-pointer'>Partnerships</a></li>
				<li><a href='/#news-section' class='hover:opacity-80 transition-opacity cursor-pointer'>News</a></li>
			</ul>
		</div>

		<div class='hidden lg:flex items-center gap-6'>
			<Button
				href=' https://shop.kfood.pk'
				class='rounded-button bg-kfood-orange px-5 py-2.5 text-white transition-opacity hover:opacity-90 text-body-sm cursor-pointer'>
				Shop Online
			</Button>
		</div>

		<button
			type='button'
			id='mobile-menu-button'
			class='lg:hidden flex items-center justify-center text-kfood-primary cursor-pointer'
			aria-label='Toggle menu'>
			<Menu class='h-7 w-7' id='menu-icon' />
			<X class='h-7 w-7 hidden' id='close-icon' />
		</button>
	</nav>

	<div id='mobile-menu' class='hidden lg:hidden bg-kfood-background border-t border-gray-200'>
		<div class='py-4 px-4 space-y-1 text-kfood-primary font-body'>
			<a href='/' class='block py-2.5 hover:opacity-80 transition-opacity cursor-pointer'>Home</a>
			<a href='/#about-kfood' class='block py-2.5 hover:opacity-80 transition-opacity cursor-pointer'>About KFood</a>
			<div class='border-t border-gray-100'>
				<button
					type='button'
					id='mobile-products-toggle'
					class='flex items-center justify-between w-full py-2.5 hover:opacity-80 transition-opacity text-left text-[15px] cursor-pointer'
					aria-expanded='false'
					aria-controls='mobile-products-list'>
					<span>Products</span>
					<ChevronDown class='h-5 w-5 shrink-0 transition-transform' id='mobile-products-chevron' />
				</button>
				<ul id='mobile-products-list' class='hidden pl-4 space-y-0 pb-2'>
					<li><a href='/#products' class='block py-1.5 hover:opacity-80 cursor-pointer'>View all</a></li>
					{
						productCategories.map((cat) =>
							cat ? (
								<li>
									<a href={cat.href} class='block py-1.5 hover:opacity-80 cursor-pointer'>
										{cat.label}
									</a>
								</li>
							) : null,
						)
					}
				</ul>
			</div>
			<!-- <div class='border-t border-gray-100'>
				<button
					type='button'
					id='mobile-brands-toggle'
					class='flex items-center justify-between w-full py-2.5 hover:opacity-80 transition-opacity text-left text-[15px] cursor-pointer'
					aria-expanded='false'
					aria-controls='mobile-brands-list'>
					<span>Our Brands</span>
					<ChevronDown class='h-5 w-5 shrink-0 transition-transform' id='mobile-brands-chevron' />
				</button>
				<ul id='mobile-brands-list' class='hidden pl-4 space-y-0 pb-2'>
					{
						brandLinks.map((item) =>
							item ? (
								<li>
									<a href={item.href} class='block py-1.5 hover:opacity-80 cursor-pointer'>
										{item.label}
									</a>
								</li>
							) : null,
						)
					}
				</ul>
			</div> -->
			<a
				href='https://waseela.global/career'
				target='_blank'
				rel='noopener noreferrer'
				class='block py-2.5 hover:opacity-80 transition-opacity cursor-pointer'>Careers</a
			>
			<a href='/#store-locator' class='block py-2.5 hover:opacity-80 transition-opacity cursor-pointer'>Find a Store</a>
			<a href='/#partner-form' class='block py-2.5 hover:opacity-80 transition-opacity cursor-pointer'>Partnerships</a>
			<a href='/#news-section' class='block py-2.5 hover:opacity-80 transition-opacity cursor-pointer'>News</a>
			<div class='pt-2 border-t border-gray-200'>
				<a
					href=' https://shop.kfood.pk'
					target='_blank'
					rel='noopener noreferrer'
					class='block w-full rounded-button bg-kfood-orange px-5 py-2.5 text-white text-center transition-opacity hover:opacity-90 cursor-pointer'>
					Shop Online
				</a>
			</div>
		</div>
	</div>
</header>

<script>
	(function () {
		const bar = document.querySelector(".announcement-bar");
		const link = document.getElementById("announcement-bar-link");
		const raw = bar?.getAttribute("data-announcements");
		if (!bar || !link || !raw) return;
		let list: { label: string; href: string }[];
		try {
			list = JSON.parse(raw);
		} catch {
			return;
		}
		if (list.length <= 1) return;
		let index = 0;
		const anchor = link as HTMLAnchorElement;
		setInterval(() => {
			index = (index + 1) % list.length;
			const item = list[index];
			if (item) {
				anchor.href = item.href;
				anchor.textContent = item.label;
			}
		}, 4000);
	})();

	const menuButton = document.getElementById("mobile-menu-button");
	const mobileMenu = document.getElementById("mobile-menu");
	const menuIcon = document.getElementById("menu-icon");
	const closeIcon = document.getElementById("close-icon");

	function closeMobileMenu() {
		mobileMenu?.classList.add("hidden");
		menuIcon?.classList.remove("hidden");
		closeIcon?.classList.add("hidden");
	}

	menuButton?.addEventListener("click", () => {
		mobileMenu?.classList.toggle("hidden");
		menuIcon?.classList.toggle("hidden");
		closeIcon?.classList.toggle("hidden");
	});

	const mobileLinks = mobileMenu?.querySelectorAll("a");
	mobileLinks?.forEach((link) => {
		link.addEventListener("click", closeMobileMenu);
	});

	const mobileProductsToggle = document.getElementById("mobile-products-toggle");
	const mobileProductsList = document.getElementById("mobile-products-list");
	const mobileProductsChevron = document.getElementById("mobile-products-chevron");

	mobileProductsToggle?.addEventListener("click", () => {
		const isHidden = mobileProductsList?.classList.toggle("hidden") ?? true;
		mobileProductsToggle.setAttribute("aria-expanded", String(!isHidden));
		mobileProductsChevron?.classList.toggle("rotate-180", !isHidden);
		mobileBrandsList?.classList.add("hidden");
		mobileBrandsToggle?.setAttribute("aria-expanded", "false");
		mobileBrandsChevron?.classList.remove("rotate-180");
	});

	const mobileBrandsToggle = document.getElementById("mobile-brands-toggle");
	const mobileBrandsList = document.getElementById("mobile-brands-list");
	const mobileBrandsChevron = document.getElementById("mobile-brands-chevron");

	mobileBrandsToggle?.addEventListener("click", () => {
		const isHidden = mobileBrandsList?.classList.toggle("hidden") ?? true;
		mobileBrandsToggle.setAttribute("aria-expanded", String(!isHidden));
		mobileBrandsChevron?.classList.toggle("rotate-180", !isHidden);
		mobileProductsList?.classList.add("hidden");
		mobileProductsToggle?.setAttribute("aria-expanded", "false");
		mobileProductsChevron?.classList.remove("rotate-180");
	});

	const productsTrigger = document.getElementById("products-trigger");
	const productsDropdown = document.getElementById("products-dropdown");
	const productsChevron = document.getElementById("products-chevron");
	const brandsTrigger = document.getElementById("brands-trigger");
	const brandsDropdown = document.getElementById("brands-dropdown");
	const brandsChevron = document.getElementById("brands-chevron");

	function closeDesktopDropdowns() {
		productsDropdown?.classList.add("hidden");
		productsTrigger?.setAttribute("aria-expanded", "false");
		productsChevron?.classList.remove("rotate-180");
		brandsDropdown?.classList.add("hidden");
		brandsTrigger?.setAttribute("aria-expanded", "false");
		brandsChevron?.classList.remove("rotate-180");
	}

	productsTrigger?.addEventListener("click", (e) => {
		e.preventDefault();
		e.stopPropagation();
		const isHidden = productsDropdown?.classList.toggle("hidden");
		productsTrigger?.setAttribute("aria-expanded", String(!isHidden));
		productsChevron?.classList.toggle("rotate-180", !isHidden);
		brandsDropdown?.classList.add("hidden");
		brandsTrigger?.setAttribute("aria-expanded", "false");
		brandsChevron?.classList.remove("rotate-180");
	});

	brandsTrigger?.addEventListener("click", (e) => {
		e.preventDefault();
		e.stopPropagation();
		const isHidden = brandsDropdown?.classList.toggle("hidden");
		brandsTrigger?.setAttribute("aria-expanded", String(!isHidden));
		brandsChevron?.classList.toggle("rotate-180", !isHidden);
		productsDropdown?.classList.add("hidden");
		productsTrigger?.setAttribute("aria-expanded", "false");
		productsChevron?.classList.remove("rotate-180");
	});

	document.addEventListener("click", (e: MouseEvent) => {
		const target = e.target as Node;
		const productsItem = document.getElementById("products-nav-item");
		const brandsItem = document.getElementById("brands-nav-item");
		const outsideProducts = productsItem && !productsItem.contains(target);
		const outsideBrands = !brandsItem || !brandsItem.contains(target);
		if (outsideProducts && outsideBrands) {
			closeDesktopDropdowns();
		}
	});
</script>
